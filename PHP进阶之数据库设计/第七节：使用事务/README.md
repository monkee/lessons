PHP进阶之数据库设计
=======

##第七节 使用事务  

**引言**

有时候，你要去取钱，你查询了一下，发现里面有100块，然后你就点击取：100块。可是呢，在你查完钱到你取钱之间，你老婆用这张卡刷了50块。那么，你能否取这100块呢？

如果，银行的代码是这么写的，先查询，判断余额是否足够，然后再给你扣钱。可是呢，在查和取之间，你又花了卡里的钱，这个过程我们假设非常快。那么，你是不是就占了银行的便宜？

如果你是银行的程序员，这样的代码是不是会让银行亏死。

**我们以买书为例**

1 点击购买，价格60元  
2 系统开始计算余额：100元，并判断是否足够（100>60）   
3 另外一个系统支付了50元（各种原因）  
4 系统开始扣钱（money = money - 60）  
6 系统出现透支（-10）

这种方法如何解决呢？

这个问题可以归纳为：

1. select money from money ... ;
2. if(money > 50) then 
3. update ... set money = money -60;(来自于另外一个系统的请求）
4. update ... set money = money - 50;
5. update ... set money = money - n;(也有可能发生）
6. select money from ... 
7. if(money < 0) rollback

**同学的方法**

1. 等一个事务处理完成后，再处理另外一个事务

2. 不让别的进程改

3. 回滚  
  无法保证

**设计思路**

1. 原子性，我们要保证这个事务原子性。在mysql里面，我们讲在这个事务的操作过程中，不会有其它SQL的干扰。
2. select -> update -> check 过程中，其它的请求是无法执行的，这里无法执行可能是：1. 阻塞状态 2. 直接报错

> select money from ... for update;  
> if(....)(sleep(60))  
> update money = money ... where ...  
> commit;  

**需要考虑的问题**

1. 事务会造成锁表，锁表必然降低性能
2. 有的事务会在业务代码里写，比如：PHP，加入，我们的验证环节非常复杂，也非常耗时，这会造成锁表时间非常长

**问答**

1. 可以锁字段吧  
	mysql innodb是行，select的时候就有where来限定这个行数
2. 需要考虑的问题解决了么？  
	我们通过分布式事务来解决
3. 事务影响客户的查询么？  
	不影响